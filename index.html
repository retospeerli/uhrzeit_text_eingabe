<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Uhrzeit â€“ Umgangssprache</title>

<style>
  body{
    margin:0;
    background:#f3f4f6;
    font-family:system-ui, sans-serif;
    display:flex;
    justify-content:center;
    padding:16px;
  }
  .app{
    background:#fff;
    border-radius:16px;
    box-shadow:0 10px 30px rgba(0,0,0,.1);
    max-width:640px;
    width:100%;
    padding:1.2rem;
  }
  h1{ text-align:center; margin:.2rem 0 .4rem; }
  .subtitle{
    text-align:center;
    color:#4b5563;
    font-size:.95rem;
    margin-bottom:.6rem;
  }
  .clock-wrap{ display:flex; justify-content:center; margin:.6rem 0; }
  canvas{ background:#f9fafb; border-radius:50%; box-shadow:inset 0 0 5px rgba(0,0,0,.08); }

  .dropdowns{
    display:grid;
    grid-template-columns:1fr 1fr 1fr;
    gap:.5rem;
    margin-top:.6rem;
  }
  label{
    font-size:.8rem;
    color:#6b7280;
    font-weight:700;
    display:block;
    margin:0 0 .2rem .1rem;
  }
  select{
    width:100%;
    padding:.6rem;
    font-size:1.05rem;
    font-weight:700;
    border-radius:12px;
    border:2px solid #d1d5db;
    background:#fff;
  }

  button{
    width:100%;
    margin-top:.7rem;
    padding:.75rem;
    border-radius:999px;
    border:none;
    background:#2563eb;
    color:white;
    font-size:1.05rem;
    font-weight:800;
    cursor:pointer;
  }
  button:active{ transform:translateY(1px); }
  button:disabled{
    background:#9ca3af;
    cursor:not-allowed;
  }

  .feedback{
    text-align:center;
    font-weight:800;
    margin-top:.65rem;
    min-height:1.5rem;
  }
  .ok{ color:#15803d; }
  .bad{ color:#b91c1c; }

  .tiny{
    margin-top:.35rem;
    text-align:center;
    color:#6b7280;
    font-size:.85rem;
  }

  .progress{
    text-align:center;
    font-size:.9rem;
    color:#6b7280;
    margin-top:.2rem;
  }

  .hidden{ display:none; }

  .result{
    text-align:center;
    padding:1rem 0 .2rem;
  }
  .result h2{ margin:.2rem 0 .4rem; }
  .result p{ color:#374151; margin:.2rem 0; }
</style>
</head>

<body>
<div class="app">
  <div id="quiz-screen">
    <h1>Wie spÃ¤t ist es?</h1>
    <div class="subtitle">Lies die Uhr ab und beschreibe die Zeit in Umgangssprache (ohne Audio).</div>

    <div class="progress" id="progress">aufgabe 1 von 30</div>

    <div class="clock-wrap">
      <canvas id="clock" width="260" height="260"></canvas>
    </div>

    <div class="dropdowns">
      <div>
        <label>minuten</label>
        <select id="sel-min">
          <option value="">â€”</option>
          <option value="fÃ¼nf">fÃ¼nf</option>
          <option value="zehn">zehn</option>
          <option value="viertel">viertel</option>
          <option value="zwanzig">zwanzig</option>
        </select>
      </div>

      <div>
        <label>form</label>
        <select id="sel-form">
          <option value="punkt">punkt</option>
          <option value="nach">nach</option>
          <option value="vor">vor</option>
          <option value="halb">halb</option>
          <option value="vor halb">vor halb</option>
          <option value="nach halb">nach halb</option>
        </select>
      </div>

      <div>
        <label>stunde</label>
        <select id="sel-hour">
          <option>eins</option><option>zwei</option><option>drei</option>
          <option>vier</option><option>fÃ¼nf</option><option>sechs</option>
          <option>sieben</option><option>acht</option><option>neun</option>
          <option>zehn</option><option>elf</option><option>zwÃ¶lf</option>
        </select>
      </div>
    </div>

    <button id="btn-check" type="button">prÃ¼fen</button>
    <div id="feedback" class="feedback"></div>
    <div class="tiny" id="hint"></div>
  </div>

  <div id="result-screen" class="hidden result">
    <h2>fertig! ðŸŽ‰</h2>
    <p id="result-text"></p>
    <p class="tiny" style="margin-top:.6rem;">
      klicke auf <strong>â€žfertigâ€œ</strong>, damit LearningView die aufgabe als erledigt markiert.
    </p>
    <button id="btn-finish" type="button">fertig</button>
  </div>
</div>

<script>
  // ======= Konfiguration =======
  const TOTAL_TASKS = 30;

  // ======= Daten / Helpers =======
  const HOUR_WORDS = ["eins","zwei","drei","vier","fÃ¼nf","sechs","sieben","acht","neun","zehn","elf","zwÃ¶lf"];

  const toHourNum = (w) => HOUR_WORDS.indexOf(w) + 1; // 1..12
  const prevHour = (h) => (h === 1 ? 12 : h - 1);

  const MIN_AFTER = { "fÃ¼nf":5, "zehn":10, "viertel":15, "zwanzig":20 };
  const MIN_BEFORE = { "fÃ¼nf":55, "zehn":50, "viertel":45, "zwanzig":40 };

  function randInt(min, max){
    return Math.floor(Math.random() * (max - min + 1)) + min;
  }

  const ALLOWED_MINUTES = [0,5,10,15,20,25,30,35,40,45,50,55];

  // ======= State =======
  let current = { h: 12, m: 0 };
  let taskIndex = 0;     // 0..29
  let correctCount = 0;

  // ======= DOM =======
  const quizScreen = document.getElementById("quiz-screen");
  const resultScreen = document.getElementById("result-screen");
  const progressEl = document.getElementById("progress");

  const selMin = document.getElementById("sel-min");
  const selForm = document.getElementById("sel-form");
  const selHour = document.getElementById("sel-hour");

  const fb = document.getElementById("feedback");
  const hint = document.getElementById("hint");

  const btnCheck = document.getElementById("btn-check");
  const btnFinish = document.getElementById("btn-finish");
  const resultText = document.getElementById("result-text");

  // ======= Clock Drawing =======
  const canvas = document.getElementById("clock");
  const ctx = canvas.getContext("2d");

  function drawClock(h, m){
    const W = canvas.width;
    const H = canvas.height;
    const R = Math.min(W,H)/2 - 12;
    const cx = W/2;
    const cy = H/2;

    ctx.clearRect(0,0,W,H);

    ctx.save();
    ctx.translate(cx, cy);

    // Face
    ctx.beginPath();
    ctx.arc(0,0,R,0,Math.PI*2);
    ctx.fillStyle = "#ffffff";
    ctx.fill();
    ctx.lineWidth = 4;
    ctx.strokeStyle = "#111827";
    ctx.stroke();

    // hour ticks
    for(let i=0;i<12;i++){
      const a = i*(Math.PI/6) - Math.PI/2;
      const inner = R - 10;
      const outer = R - (i%3===0 ? 22 : 16);
      ctx.beginPath();
      ctx.moveTo(inner*Math.cos(a), inner*Math.sin(a));
      ctx.lineTo(outer*Math.cos(a), outer*Math.sin(a));
      ctx.lineWidth = (i%3===0 ? 4 : 2);
      ctx.strokeStyle = "#111827";
      ctx.stroke();
    }

    // minute hand (blue)
    const ma = (Math.PI/30)*m - Math.PI/2;
    ctx.beginPath();
    ctx.moveTo(0,0);
    ctx.lineTo((R-28)*Math.cos(ma), (R-28)*Math.sin(ma));
    ctx.lineWidth = 6;
    ctx.strokeStyle = "#2563eb";
    ctx.lineCap = "round";
    ctx.stroke();

    // hour hand (red)
    const ha = (Math.PI/6)*( (h%12) + m/60 ) - Math.PI/2;
    ctx.beginPath();
    ctx.moveTo(0,0);
    ctx.lineTo((R-60)*Math.cos(ha), (R-60)*Math.sin(ha));
    ctx.lineWidth = 8;
    ctx.strokeStyle = "#dc2626";
    ctx.lineCap = "round";
    ctx.stroke();

    // center
    ctx.beginPath();
    ctx.arc(0,0,6,0,Math.PI*2);
    ctx.fillStyle = "#111827";
    ctx.fill();

    ctx.restore();
  }

  // ======= Task generation =======
  function updateProgress(){
    progressEl.textContent = `aufgabe ${taskIndex + 1} von ${TOTAL_TASKS}`;
  }

  function resetInputs(){
    selMin.value = "";
    selForm.value = "punkt";
    selHour.value = "eins";
  }

  function newTask(){
    const h = randInt(1, 12);
    const m = ALLOWED_MINUTES[randInt(0, ALLOWED_MINUTES.length-1)];
    current = { h, m };
    drawClock(current.h, current.m);

    fb.textContent = "";
    fb.className = "feedback";
    hint.textContent = "";

    resetInputs();
    updateProgress();
  }

  // ======= Convert dropdowns -> (h,m) =======
  function selectionToTime(minWord, formWord, hourWord){
    const H = toHourNum(hourWord); // spoken hour
    let h, m;

    if(formWord === "punkt"){
      h = H; m = 0;
      return { h, m, valid:true };
    }

    if(formWord === "halb"){
      h = prevHour(H); m = 30;
      return { h, m, valid:true };
    }

    if(formWord === "vor halb"){
      h = prevHour(H); m = 25;
      return { h, m, valid:true };
    }

    if(formWord === "nach halb"){
      h = prevHour(H); m = 35;
      return { h, m, valid:true };
    }

    if(formWord === "nach"){
      if(!MIN_AFTER[minWord]) return { valid:false };
      h = H; m = MIN_AFTER[minWord];
      return { h, m, valid:true };
    }

    if(formWord === "vor"){
      if(!MIN_BEFORE[minWord]) return { valid:false };
      h = prevHour(H); m = MIN_BEFORE[minWord];
      return { h, m, valid:true };
    }

    return { valid:false };
  }

  // ======= Finish / LearningView =======
  function showResult(){
    quizScreen.classList.add("hidden");
    resultScreen.classList.remove("hidden");

    resultText.innerHTML =
      `du hast <strong>${TOTAL_TASKS}</strong> aufgaben gemacht.<br>` +
      `richtig gelÃ¶st: <strong>${correctCount}</strong>.`;
  }

  btnFinish.addEventListener("click", () => {
    btnFinish.disabled = true;
    btnFinish.textContent = "erledigt âœ”";
    try {
      if (window.parent && window.parent !== window) {
        window.parent.postMessage("AppSolved", "*");
      }
    } catch (e) {
      console.warn("LearningView-AppSolved nicht mÃ¶glich:", e);
    }
  });

  // ======= Check =======
  function check(){
    const minWord = selMin.value;     // may be ""
    const formWord = selForm.value;
    const hourWord = selHour.value;

    const sel = selectionToTime(minWord, formWord, hourWord);

    if(!sel.valid){
      fb.textContent = "unvollstÃ¤ndig â€“ wÃ¤hle passende minuten";
      fb.className = "feedback bad";
      return;
    }

    const ok = (sel.h === current.h && sel.m === current.m);

    if(ok){
      correctCount++;
      fb.textContent = "richtig âœ”";
      fb.className = "feedback ok";

      taskIndex++;
      if(taskIndex >= TOTAL_TASKS){
        setTimeout(showResult, 400);
      } else {
        setTimeout(newTask, 600);
      }
    } else {
      fb.textContent = "falsch âœ˜";
      fb.className = "feedback bad";
      hint.textContent = "tipp: bei â€žhalb / vor halb / nach halbâ€œ ist die genannte stunde die nÃ¤chste stunde.";
    }
  }

  btnCheck.addEventListener("click", check);

  // ======= Start =======
  (function init(){
    taskIndex = 0;
    correctCount = 0;
    newTask();
  })();
</script>
</body>
</html>
