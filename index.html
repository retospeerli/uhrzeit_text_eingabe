<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>uhrzeit â€“ umgangssprache (dropdown)</title>
  <style>
    :root{font-family:system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",sans-serif;background:#f3f4f6;}
    body{margin:0;min-height:100vh;display:flex;align-items:center;justify-content:center;padding:14px;}
    .app{background:#fff;border-radius:16px;box-shadow:0 10px 30px rgba(0,0,0,.1);padding:1.6rem 1.4rem;max-width:560px;width:100%;box-sizing:border-box;}
    h1{margin:0 0 .4rem;text-align:center;font-size:1.6rem;}
    .subtitle{text-align:center;color:#4b5563;margin-bottom:1rem;font-size:.95rem;}
    .hidden{display:none;}
    .center{text-align:center;}
    .choice-grid{display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:.6rem;margin:.7rem 0 .4rem;}
    .choice-btn{padding:.9rem .6rem;border-radius:16px;border:2px solid #d1d5db;background:#f9fafb;font-size:1rem;font-weight:600;cursor:pointer;transition:background .15s,transform .05s,border-color .15s,box-shadow .15s;}
    .choice-btn.selected{background:#2563eb;color:#fff;border-color:#1d4ed8;box-shadow:0 5px 15px rgba(37,99,235,.35);}
    .choice-btn:active{transform:translateY(1px);}
    .selected-info{font-size:.85rem;color:#6b7280;text-align:center;min-height:1.2rem;margin:.2rem 0 .3rem;}
    .primary-btn{margin-top:.8rem;width:100%;padding:.75rem 1rem;font-size:1.1rem;border-radius:999px;border:none;cursor:pointer;background:#2563eb;color:#fff;font-weight:700;}
    .primary-btn:hover{background:#1d4ed8;}
    .primary-btn:disabled{background:#9ca3af;cursor:not-allowed;}
    .secondary-btn{margin-top:.4rem;width:100%;padding:.65rem 1rem;font-size:1rem;border-radius:999px;border:1px solid #d1d5db;cursor:pointer;background:#f9fafb;color:#111827;font-weight:600;}
    .secondary-btn:hover{background:#e5e7eb;border-color:#9ca3af;}
    .progress{text-align:center;color:#6b7280;font-size:.9rem;margin-bottom:.4rem;}
    .tag{display:inline-block;border-radius:999px;padding:.15rem .6rem;font-size:.8rem;background:#eff6ff;color:#1d4ed8;}
    .clock-wrapper{display:flex;justify-content:center;margin-top:.6rem;}
    #clock-canvas{background:#f9fafb;border-radius:50%;box-shadow:inset 0 0 5px rgba(0,0,0,.08);}
    .answer-box{margin-top:1rem;border:1px solid #e5e7eb;background:#f9fafb;border-radius:14px;padding:.9rem;}
    .answer-row{display:grid;grid-template-columns:1fr;gap:.6rem;}
    @media (min-width:520px){.answer-row{grid-template-columns:1fr 1fr 1fr;}}
    select{width:100%;padding:.7rem .6rem;border-radius:12px;border:2px solid #d1d5db;background:#fff;font-size:1.02rem;font-weight:650;color:#111827;outline:none;text-transform:lowercase;}
    select:focus{border-color:#2563eb;box-shadow:0 0 0 3px rgba(37,99,235,.15);}
    .equation{text-align:center;margin:.4rem 0 .2rem;font-size:1.05rem;color:#111827;font-weight:600;}
    .feedback{min-height:1.4rem;margin-top:.55rem;font-weight:650;text-align:center;}
    .feedback.ok{color:#15803d;}
    .feedback.error{color:#b91c1c;}
    .stats{margin-top:.9rem;font-size:.95rem;color:#374151;}
  </style>
</head>
<body>
<div class="app">
  <h1>wie spÃ¤t ist es?</h1>
  <div class="subtitle">
    lies die analoge uhr und wÃ¤hle die uhrzeit <strong>in umgangssprache</strong>.<br>
    beispiel: â€žfÃ¼nf vor halb neunâ€œ, â€žfÃ¼nf nach halb elfâ€œ, â€žviertel vor zwÃ¶lfâ€œ, â€žein uhrâ€œ
  </div>

  <!-- start -->
  <div id="start-screen">
    <div class="center">
      <p>bitte eine <strong>klasse</strong> und eine <strong>schwierigkeit</strong> auswÃ¤hlen.</p>
    </div>

    <div class="center" style="margin-top:.5rem;">klasse</div>
    <div class="choice-grid" id="grade-grid">
      <button type="button" class="choice-btn grade-btn" data-grade="2">2. klasse</button>
      <button type="button" class="choice-btn grade-btn" data-grade="3">3. klasse</button>
    </div>

    <div class="center" style="margin-top:1rem;">schwierigkeit</div>
    <div class="choice-grid" id="difficulty-grid">
      <button type="button" class="choice-btn difficulty-btn" data-diff="easy">einfach</button>
      <button type="button" class="choice-btn difficulty-btn" data-diff="hard">schwierig</button>
    </div>

    <div class="selected-info" id="selected-info"></div>
    <button class="primary-btn" id="start-btn" disabled>los!</button>
  </div>

  <!-- quiz -->
  <div id="quiz-screen" class="hidden">
    <div class="progress" id="progress-text"></div>
    <div class="center">
      <span class="tag" id="variant-label"></span>
      <div class="equation">wÃ¤hle die passende uhrzeit:</div>
    </div>

    <div class="clock-wrapper">
      <canvas id="clock-canvas" width="220" height="220"></canvas>
    </div>

    <div class="answer-box">
      <div class="answer-row">
        <select id="sel-part1" aria-label="teil 1"></select>
        <select id="sel-part2" aria-label="teil 2"></select>
        <select id="sel-hour"  aria-label="stunde"></select>
      </div>
      <button class="primary-btn" id="check-btn" style="margin-top:.8rem;">Ã¼berprÃ¼fen</button>
      <div class="feedback" id="feedback"></div>
    </div>

    <div class="stats">
      richtig: <span id="stat-correct">0</span> / <span id="stat-total">30</span><br>
      falsche versuche: <span id="stat-wrong">0</span><br>
      modus: <span id="stat-mode"></span>
    </div>
  </div>

  <!-- result -->
  <div id="result-screen" class="hidden center">
    <h2>fertig! ðŸŽ‰</h2>
    <p id="result-summary"></p>
    <p style="margin-top:.8rem; font-size:.9rem; color:#4b5563;">
      wenn du fertig bist, klicke auf <strong>â€žfertigâ€œ</strong>, damit learningview den auftrag als erledigt markiert.<br>
      oder klicke auf <strong>â€žweiter Ã¼benâ€œ</strong>.
    </p>
    <button class="primary-btn" id="finish-btn">fertig</button>
    <button class="secondary-btn" id="restart-btn">weiter Ã¼ben</button>
  </div>
</div>

<script>
  const TOTAL_QUESTIONS = 30;

  const GRADE_LABELS = { 2: "2. klasse", 3: "3. klasse" };
  const DIFF_LABELS = { easy: "einfach", hard: "schwierig" };

  // dropdowns: ALLES klein
  const PART1_OPTIONS = ["", "fÃ¼nf", "zehn", "viertel", "zwanzig"];
  const PART2_OPTIONS = ["", "nach", "vor", "halb", "punkt", "vor halb", "nach halb"];
  const HOUR_OPTIONS_WORDS = ["eins","zwei","drei","vier","fÃ¼nf","sechs","sieben","acht","neun","zehn","elf","zwÃ¶lf"];

  let selectedGrade = null;       // 2|3
  let selectedDifficulty = null;  // easy|hard

  let questionsDone = 0;
  let correctAnswers = 0;
  let wrongAnswers = 0;
  let usedQuestions = [];
  let currentQuestion = null; // {hour, minute, label, correctSet:Set<string>, canonical:string}

  // dom
  const startScreen = document.getElementById("start-screen");
  const quizScreen = document.getElementById("quiz-screen");
  const resultScreen = document.getElementById("result-screen");

  const gradeGrid = document.getElementById("grade-grid");
  const difficultyGrid = document.getElementById("difficulty-grid");
  const selectedInfo = document.getElementById("selected-info");
  const startBtn = document.getElementById("start-btn");

  const progressText = document.getElementById("progress-text");
  const variantLabel = document.getElementById("variant-label");
  const feedback = document.getElementById("feedback");

  const statCorrect = document.getElementById("stat-correct");
  const statTotal = document.getElementById("stat-total");
  const statWrong = document.getElementById("stat-wrong");
  const statMode = document.getElementById("stat-mode");

  const restartBtn = document.getElementById("restart-btn");
  const finishBtn = document.getElementById("finish-btn");
  const resultSummary = document.getElementById("result-summary");

  const selPart1 = document.getElementById("sel-part1");
  const selPart2 = document.getElementById("sel-part2");
  const selHour  = document.getElementById("sel-hour");
  const checkBtn = document.getElementById("check-btn");

  const clockCanvas = document.getElementById("clock-canvas");
  const clockCtx = clockCanvas.getContext("2d");

  // helpers
  function randomInt(min, max){ return Math.floor(Math.random()*(max-min+1))+min; }
  function randomIntStep(min, max, step){
    const count = Math.floor((max-min)/step)+1;
    return min + randomInt(0, count-1)*step;
  }
  function normSpaces(s){ return s.replace(/\s+/g," ").trim(); }

  function fillSelect(select, arr){
    select.innerHTML = "";
    arr.forEach(v=>{
      const opt = document.createElement("option");
      opt.value = v;
      opt.textContent = (v === "") ? "â€”" : v; // alles klein!
      select.appendChild(opt);
    });
  }
  fillSelect(selPart1, PART1_OPTIONS);
  fillSelect(selPart2, PART2_OPTIONS);
  fillSelect(selHour, ["", ...HOUR_OPTIONS_WORDS]);

  function resetDropdowns(){
    selPart1.value = "";
    selPart2.value = "";
    selHour.value = "";
  }

  function hourToWord(h){
    const map = {1:"eins",2:"zwei",3:"drei",4:"vier",5:"fÃ¼nf",6:"sechs",7:"sieben",8:"acht",9:"neun",10:"zehn",11:"elf",12:"zwÃ¶lf"};
    return map[h] || String(h);
  }
  function hourToWordEin(h){ return (h === 1) ? "ein" : hourToWord(h); }

  function nextHourWord(word){
    const order = ["eins","zwei","drei","vier","fÃ¼nf","sechs","sieben","acht","neun","zehn","elf","zwÃ¶lf"];
    const idx = order.indexOf(word);
    return idx === -1 ? null : order[(idx+1)%12];
  }

  // startauswahl
  gradeGrid.querySelectorAll(".grade-btn").forEach(btn=>{
    btn.addEventListener("click", ()=>{
      const g = Number(btn.dataset.grade);
      selectedGrade = (selectedGrade === g) ? null : g;
      gradeGrid.querySelectorAll(".grade-btn").forEach(b=>{
        b.classList.toggle("selected", Number(b.dataset.grade) === selectedGrade);
      });
      updateStartControls();
    });
  });

  difficultyGrid.querySelectorAll(".difficulty-btn").forEach(btn=>{
    btn.addEventListener("click", ()=>{
      const d = btn.dataset.diff;
      selectedDifficulty = (selectedDifficulty === d) ? null : d;
      difficultyGrid.querySelectorAll(".difficulty-btn").forEach(b=>{
        b.classList.toggle("selected", b.dataset.diff === selectedDifficulty);
      });
      updateStartControls();
    });
  });

  function updateStartControls(){
    if(!selectedGrade && !selectedDifficulty){
      selectedInfo.textContent = "keine klasse und schwierigkeit ausgewÃ¤hlt.";
      startBtn.disabled = true; return;
    }
    if(!selectedGrade){
      selectedInfo.textContent = "bitte eine klasse auswÃ¤hlen.";
      startBtn.disabled = true; return;
    }
    if(!selectedDifficulty){
      selectedInfo.textContent = "bitte eine schwierigkeit auswÃ¤hlen.";
      startBtn.disabled = true; return;
    }
    selectedInfo.textContent = `ausgewÃ¤hlt: ${GRADE_LABELS[selectedGrade]}, ${DIFF_LABELS[selectedDifficulty]}`;
    startBtn.disabled = false;
  }

  startBtn.addEventListener("click", startTraining);

  restartBtn.addEventListener("click", ()=>{
    quizScreen.classList.add("hidden");
    resultScreen.classList.add("hidden");
    startScreen.classList.remove("hidden");
  });

  // learningview feedback
  finishBtn.addEventListener("click", ()=>{
    finishBtn.disabled = true;
    finishBtn.textContent = "erledigt âœ”";
    try{
      if(window.parent && window.parent !== window){
        window.parent.postMessage("AppSolved","*");
      }
    }catch(e){
      console.warn("learningview-rÃ¼ckmeldung nicht mÃ¶glich:", e);
    }
  });

  checkBtn.addEventListener("click", checkAnswer);
  [selPart1, selPart2, selHour].forEach(el=>{
    el.addEventListener("keydown", (e)=>{
      if(e.key === "Enter"){ e.preventDefault(); checkAnswer(); }
    });
  });

  function startTraining(){
    if(!selectedGrade || !selectedDifficulty) return;

    questionsDone = 0;
    correctAnswers = 0;
    wrongAnswers = 0;
    usedQuestions = [];

    statCorrect.textContent = "0";
    statWrong.textContent = "0";
    statTotal.textContent = String(TOTAL_QUESTIONS);
    statMode.textContent = `${GRADE_LABELS[selectedGrade]} â€“ ${DIFF_LABELS[selectedDifficulty]}`;

    feedback.textContent = "";
    feedback.className = "feedback";

    startScreen.classList.add("hidden");
    resultScreen.classList.add("hidden");
    quizScreen.classList.remove("hidden");

    newQuestion();
  }

  function newQuestion(){
    feedback.textContent = "";
    feedback.className = "feedback";
    resetDropdowns();

    let q, tries = 0;
    while(true){
      q = generateTimeQuestion(selectedGrade, selectedDifficulty);
      const key = `${q.hour}-${q.minute}-${selectedGrade}-${selectedDifficulty}`;
      if(!usedQuestions.includes(key)){
        usedQuestions.push(key);
        break;
      }
      if(++tries > 450) break;
    }

    currentQuestion = q;
    variantLabel.textContent = q.label;

    drawClock(q.hour, q.minute);

    progressText.textContent = `aufgabe ${questionsDone + 1} von ${TOTAL_QUESTIONS}`;
  }

  function checkAnswer(){
    if(!currentQuestion) return;

    const p1 = selPart1.value; // ""|fÃ¼nf|zehn|viertel|zwanzig
    const p2 = selPart2.value; // ""|nach|vor|halb|punkt|vor halb|nach halb
    const h  = selHour.value;  // ""|eins..zwÃ¶lf

    if(!p2 || !h){
      feedback.textContent = "bitte mindestens teil 2 und die stunde auswÃ¤hlen.";
      feedback.className = "feedback error";
      return;
    }

    const built = buildPhraseFromDropdown(p1, p2, h);
    if(!built){
      feedback.textContent = "diese kombination passt nicht. (bei â€žhalb / vor halb / nach halbâ€œ bitte kein â€žfÃ¼nf/zehn/â€¦â€œ wÃ¤hlen.)";
      feedback.className = "feedback error";
      return;
    }

    const ok = currentQuestion.correctSet.has(built);

    if(ok){
      correctAnswers++;
      statCorrect.textContent = String(correctAnswers);
      feedback.textContent = "richtig! ðŸ‘";
      feedback.className = "feedback ok";
    }else{
      wrongAnswers++;
      statWrong.textContent = String(wrongAnswers);
      feedback.textContent = "leider falsch. richtig wÃ¤re z.b.: " + currentQuestion.canonical;
      feedback.className = "feedback error";
    }

    questionsDone++;
    if(questionsDone >= TOTAL_QUESTIONS){
      setTimeout(endTraining, 700);
    }else{
      setTimeout(newQuestion, 700);
    }
  }

  // âœ… verbessert: p1+p2 korrekt fÃ¼r â€žvor halb / nach halbâ€œ
  // beispiel 08:25 -> "fÃ¼nf" + "vor halb" + "neun"
  // beispiel 10:35 -> "fÃ¼nf" + "nach halb" + "elf"
  function buildPhraseFromDropdown(p1, p2, hourWord){
    hourWord = normSpaces(hourWord);

    // punkt -> "<ein> uhr"
    if(p2 === "punkt"){
      if(p1) return null;
      const hEin = (hourWord === "eins") ? "ein" : hourWord;
      return normSpaces(`${hEin} uhr`);
    }

    // halb -> braucht KEIN p1, und nimmt nÃ¤chste stunde
    if(p2 === "halb"){
      if(p1) return null;
      const next = nextHourWord(hourWord);
      if(!next) return null;
      return normSpaces(`halb ${next}`);
    }

    // vor halb / nach halb -> MUSS p1 haben, nimmt nÃ¤chste stunde
    if(p2 === "vor halb" || p2 === "nach halb"){
      if(!p1) return null;
      const next = nextHourWord(hourWord);
      if(!next) return null;
      return normSpaces(`${p1} ${p2} ${next}`);
    }

    // vor / nach -> MUSS p1 haben, nimmt aktuelle stunde
    if(p2 === "vor" || p2 === "nach"){
      if(!p1) return null;
      return normSpaces(`${p1} ${p2} ${hourWord}`);
    }

    return null;
  }

  function endTraining(){
    quizScreen.classList.add("hidden");
    resultScreen.classList.remove("hidden");

    const quote = (correctAnswers / TOTAL_QUESTIONS * 100).toFixed(0);
    const modeText = `${GRADE_LABELS[selectedGrade]}, ${DIFF_LABELS[selectedDifficulty]}`;

    resultSummary.innerHTML =
      `du hast <strong>${TOTAL_QUESTIONS}</strong> uhrzeiten im modus <strong>${modeText}</strong> gelÃ¶st.<br>` +
      `davon waren <strong>${correctAnswers}</strong> richtig (<strong>${quote}%</strong>).<br>` +
      `du hattest insgesamt <strong>${wrongAnswers}</strong> falsche versuche.`;
  }

  // aufgabengenerator
  function generateTimeQuestion(grade, difficulty){
    let hour, minute, label;

    if(grade === 2){
      if(difficulty === "easy"){
        hour = randomInt(1,12);
        minute = Math.random() < 0.5 ? 0 : 30;
        label = "volle und halbe stunden";
      }else{
        const minuteChoices = [0,10,15,20,25,30,35,40,45,50,55];
        hour = randomInt(1,12);
        minute = minuteChoices[randomInt(0, minuteChoices.length-1)];
        label = "umgangssprache-mix (inkl. vor/nach halb)";
      }
    }else{
      // 3. klasse: 5er-schritte inkl. 25/35/55 usw.
      hour = randomInt(1,12);
      minute = randomIntStep(0,55,5);
      label = (difficulty === "easy") ? "5-minuten-schritte" : "5-minuten-schritte (mix)";
    }

    const forms = timeToDropdownForms(hour, minute);
    return { hour, minute, label, correctSet: forms.set, canonical: forms.canonical };
  }

  // âœ… verbessert: erzeugt EXAKT die umgangsformen passend zu dropdowns,
  // inkl. "fÃ¼nf vor halb" und "fÃ¼nf nach halb"
  function timeToDropdownForms(hour, minute){
    const h = ((hour - 1) % 12) + 1;
    const nextH = (h % 12) + 1;

    const hourWord = hourToWord(h);
    const nextWord = hourToWord(nextH);

    const set = new Set();
    let canonical = "";

    function add(s){
      const t = normSpaces(s.toLowerCase());
      set.add(t);
      if(!canonical) canonical = t;
    }

    if(minute === 0){
      add(`${hourToWordEin(h)} uhr`);
      return { set, canonical };
    }

    switch(minute){
      case 5:  add(`fÃ¼nf nach ${hourWord}`); break;
      case 10: add(`zehn nach ${hourWord}`); break;
      case 15: add(`viertel nach ${hourWord}`); break;
      case 20: add(`zwanzig nach ${hourWord}`); break;

      // vor/nach halb:
      case 25: add(`fÃ¼nf vor halb ${nextWord}`); break;
      case 30: add(`halb ${nextWord}`); break;
      case 35: add(`fÃ¼nf nach halb ${nextWord}`); break;

      case 40: add(`zwanzig vor ${nextWord}`); break;
      case 45: add(`viertel vor ${nextWord}`); break;
      case 50: add(`zehn vor ${nextWord}`); break;
      case 55: add(`fÃ¼nf vor ${nextWord}`); break;

      default:
        // sollte bei 5er-schritten nie passieren
        add(`${hourToWordEin(h)} uhr`);
    }

    return { set, canonical };
  }

  // analoge uhr zeichnen
  function drawClock(hour, minute){
    const ctx = clockCtx;
    const w = clockCanvas.width;
    const h = clockCanvas.height;
    const radius = Math.min(w,h)/2 - 10;
    const cx = w/2, cy = h/2;

    ctx.clearRect(0,0,w,h);
    ctx.save(); ctx.translate(cx,cy);

    ctx.beginPath();
    ctx.arc(0,0,radius,0,Math.PI*2);
    ctx.fillStyle="#ffffff"; ctx.fill();
    ctx.lineWidth=3; ctx.strokeStyle="#111827"; ctx.stroke();

    for(let i=0;i<12;i++){
      const angle = (Math.PI/6)*i - Math.PI/2;
      const inner = radius - 10;
      const outer = radius - (i%3===0 ? 18 : 14);
      ctx.beginPath();
      ctx.moveTo(inner*Math.cos(angle), inner*Math.sin(angle));
      ctx.lineTo(outer*Math.cos(angle), outer*Math.sin(angle));
      ctx.lineWidth = (i%3===0)?3:1.5;
      ctx.strokeStyle="#111827";
      ctx.stroke();
    }

    ctx.beginPath();
    ctx.arc(0,0,4,0,Math.PI*2);
    ctx.fillStyle="#111827"; ctx.fill();

    const minuteAngle = (Math.PI/30)*minute - Math.PI/2;
    ctx.beginPath();
    ctx.moveTo(0,0);
    ctx.lineTo((radius-22)*Math.cos(minuteAngle),(radius-22)*Math.sin(minuteAngle));
    ctx.lineWidth=3; ctx.strokeStyle="#1f2937"; ctx.stroke();

    const hourIn12 = hour % 12;
    const hourAngle = (Math.PI/6)*(hourIn12 + minute/60) - Math.PI/2;
    ctx.beginPath();
    ctx.moveTo(0,0);
    ctx.lineTo((radius-45)*Math.cos(hourAngle),(radius-45)*Math.sin(hourAngle));
    ctx.lineWidth=4; ctx.strokeStyle="#111827"; ctx.stroke();

    ctx.restore();
  }

  // init
  (function init(){
    statTotal.textContent = String(TOTAL_QUESTIONS);
    updateStartControls();
    drawClock(12,0);
  })();
</script>
</body>
</html>
